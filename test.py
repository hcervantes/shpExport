"""
exportShp.py
Converts JSON feature classes into shapefile using the shapefile.py created by jlawhed<at>geospatialpython.com
author: hector_cervantes<at>msn.com
date: 20130606
version: 1.0
Compatible with Python versions 2.4-3.x
"""
import sys, os, json
import shapefile

def WriteFields(fields, w):
    # Write the fields
    for field in fields:
        fieldType = field["type"]
        # get the lenght if exists
        if(field["length"]):
            fldLen = field["length"] 
                
        fieldType = fieldType.upper()
        if("SHAPE" in fieldType or "GEOMETRY"  in fieldType):
            continue            
        elif("INTEGER" in fieldType):
            fieldType = 'I'
        elif("string" in fieldType):            fieldType = 'C'
                
        elif("DATE" in fieldType):
            fieldType = 'D'
        elif("DOUBLE" in fieldType or "OID" in fieldType):
            fieldType = 'N'
        # Now create the field
        if(fldLen):
            w.field(field["name"], fieldType, fldLen)
        else:
            w.field(field["name"], fieldType)
                
                
def WritePoints(features, fields):
    for feature in features:
        print feature["geometry"]
        
def WritePolygons(features, fields):
    for feature in features:
        print feature["geometry"]
        
def WritePolylines(features, fields):
    w = shapefile.Writer(shapefile.POLYGON)
    # Create the fields
    WriteFields(fields, w)
    # Itererate over the features to create geometries and attributes
    for feature in features:        
        # Write the geometries
        for geom in feature["geometry"]:
            w.poly(parts=geom)
     
            
if (len(sys.argv) == 0):
    print 'Expected Featureset as argument'
    exit
jsonInput = sys.argv[0]

jsonInput = '''[{
    "displayFieldName" : "NAME",
    "fieldAliases" : {
        "OBJECTID" : "OBJECTID",
        "NAME" : "Name",
        "MEDNW_CY" : "2012 Median Net Worth (Esri)"
    },
    "geometryType" : "esriGeometryPolygon",
    "spatialReference" : {
        "wkid" : 102100
    },
    "fields" : [{
        "name" : "OBJECTID",
        "type" : "esriFieldTypeOID",
        "alias" : "OBJECTID"
    }, {
        "name" : "NAME",
        "type" : "esriFieldTypeString",
        "alias" : "Name",
        "length" : 20
    }, {
        "name" : "MEDNW_CY",
        "type" : "esriFieldTypeInteger",
        "alias" : "2012 Median Net Worth (Esri)"
    }],
    "features" : [{
        "attributes" : {
            "OBJECTID" : 6,
            "NAME" : "Colorado",
            "MEDNW_CY" : 71324
        },
        "geometry" : {
            "rings" : [[[-11908812.630199999, 5012840.8134000003], [-11769743.6382, 5011872.9183999971], [-11360345.171499999, 5012689.6213999987], [-11359273.389799999, 4438133.3548000008], [-11467416.930600001, 4439136.3372000009], [-11691799.9596, 4438093.0715000033], [-11896691.4947, 4438050.8405999988], [-11897525.8367, 4439126.4426999986], [-12138858.6976, 4438979.5275000036], [-12138473.423700001, 4602717.1797000021], [-12140510.5691, 4618416.6023000032], [-12139398.9318, 5012438.8655999973], [-11908812.630199999, 5012840.8134000003]], [[-11411318.533500001, 4975450.0292000026], [-11411312.8002, 4975449.9598999992], [-11411319.342599999, 4975450.0697000027], [-11411318.533500001, 4975450.0292000026]]]
        }
    }, {
        "attributes" : {
            "OBJECTID" : 29,
            "NAME" : "Nebraska",
            "MEDNW_CY" : 68657
        },
        "geometry" : {
            "rings" : [[[-11573442.6523, 5312231.1653999984], [-11313734.5847, 5311401.8390000015], [-10964808.482899999, 5311752.5183999985], [-10961335.928400001, 5303992.7404000014], [-10958752.0931, 5301207.9513999969], [-10956146.6598, 5301615.7192000002], [-10947852.243799999, 5297180.6423000023], [-10945585.1143, 5294711.9175999984], [-10937341.459799999, 5292634.3502999991], [-10930439.762, 5287899.2762999982], [-10925686.1993, 5287593.8175000027], [-10923522.702299999, 5284607.3408999965], [-10916822.6054, 5279248.3395999968], [-10915978.4671, 5277432.6072999984], [-10913214.183900001, 5276136.2395000011], [-10909351.4002, 5275994.4622000009], [-10902268.6938, 5277890.5991000012], [-10896914.339199999, 5284185.5925000012], [-10895454.272399999, 5290482.5336000025], [-10891717.8346, 5291926.8454999998], [-10884194.307499999, 5289128.636500001], [-10874408.875399999, 5287985.6626999974], [-10866097.097899999, 5290438.6498000026], [-10860095.0853, 5288793.384300001], [-10854189.9199, 5290455.3526000008], [-10852204.3105, 5289256.4851000011], [-10847389.300000001, 5288563.5099999979], [-10843343.167099999, 5291961.0196999982], [-10839924.0997, 5291475.6099999994], [-10838017.646500001, 5289899.4038999975], [-10832129.732999999, 5291841.4878999963], [-10830257.5638, 5290003.1230999976], [-10823808.823799999, 5289370.8269999996], [-10822263.3762, 5288426.1019999981], [-10821381.7289, 5282989.6551999971], [-10814773.468499999, 5280906.4934], [-10812490.751599999, 5277262.4526999965], [-10805474.613700001, 5277381.0424999967], [-10795666.2543, 5275526.1020999998], [-10793674.7498, 5272574.9844999984], [-10793713.2644, 5269425.5487999991], [-10787615.294600001, 5271540.8677999973], [-10776418.3379, 5267048.9378999993], [-10775969.050100001, 5262214.9996000007], [-10774973.633099999, 5261274.2162000015], [-10771725.9976, 5260662.9228999987], [-10767714.7093, 5261404.2611000016], [-10763622.7159, 5259787.2285000011], [-10763235.546399999, 5258242.6652000025], [-10765650.8453, 5254601.7974999994], [-10765688.360099999, 5252055.9047000036], [-10762820.213199999, 5247725.6393000036], [-10758314.672599999, 5244875.7153000012], [-10756599.9027, 5238735.4798000008], [-10754741.650599999, 5237092.7400000021], [-10752474.0702, 5236990.2057000026], [-10747762.0276, 5239276.6272], [-10745534.412599999, 5238177.1441999972], [-10742477.6918, 5233569.4622000009], [-10739968.215700001, 5233109.5402000025], [-10736262.0568, 5234759.1402999982], [-10731417.3223, 5234126.6187999994], [-10729640.7752, 5232323.7923000008], [-10729051.004799999, 5228083.2769000009], [-10732889.410499999, 5221720.7210000008], [-10732138.0044, 5217483.7542999983], [-10733178.842700001, 5213771.0530000031], [-10732089.248500001, 5211656.2945000008], [-10728450.103, 5208785.0094000027], [-10727386.331700001, 5203889.6116999984], [-10723283.7618, 5199212.4136999995], [-10722707.7929, 5195477.8484999985], [-10724185.5623, 5193610.6670999974], [-10726731.6631, 5192571.6319999993], [-10725340.6153, 5189945.1613000035], [-10725477.3123, 5186182.3977999985], [-10721153.2195, 5180788.1184], [-10718174.7533, 5179726.9188999981], [-10716667.1558, 5178103.829400003], [-10716475.6863, 5175528.9177000001], [-10717782.578600001, 5171602.8425000012], [-10717216.405999999, 5168358.813500002], [-10715431.1723, 5166724.0204999968], [-10712302.762399999, 5166888.1471000016], [-10711373.023700001, 5165408.1177999973], [-10713480.4133, 5162374.8907999992], [-10713467.1666, 5160882.2274999991], [-10711959.788699999, 5160130.4457999989], [-10710629.853499999, 5161983.2766999975], [-10708328.9889, 5162277.0552000031], [-10707154.1238, 5161438.2801999971], [-10708060.154899999, 5158652.063699998], [-10707512.239700001, 5157676.4356999993], [-10704265.0493, 5158025.1947000027], [-10701182.170399999, 5156915.320100002], [-10702766.0228, 5152227.0370000005], [-10701893.275900001, 5149126.929399997], [-10704381.8243, 5147515.9249000028], [-10704677.712300001, 5146283.8830000013], [-10702468.244899999, 5141376.2846999988], [-10698977.2631, 5138416.8852000013], [-10698533.8762, 5133996.5287000015], [-10695217.557, 5132341.7732999995], [-10693943.2842, 5130645.197300002], [-10695675.751, 5124726.9355999976], [-10698513.2838, 5121778.0489000008], [-10698049.304500001, 5120268.2956999987], [-10695202.865499999, 5118480.9465999976], [-10694822.4869, 5116751.935999997], [-10696093.1995, 5115804.7258000001], [-10699301.5342, 5115783.8559999987], [-10700319.329600001, 5113617.9892999977], [-10697271.07, 5108711.4602999985], [-10699837.6534, 5103476.7299999967], [-10698855.592800001, 5100768.3694000021], [-10695731.4077, 5097959.1273000017], [-10697251.142200001, 5094517.4215999991], [-10697183.7936, 5092240.9408000037], [-10695872.115800001, 5090235.0164000019], [-10691192.132099999, 5087398.2290999964], [-10689638.558499999, 5092375.2393999994], [-10687240.182, 5092804.1717000008], [-10685867.056500001, 5088543.3413999975], [-10688846.632300001, 5085124.0254999995], [-10688183.3928, 5083173.9658000022], [-10682962.8397, 5080938.9356999993], [-10679584.517899999, 5081218.0631000027], [-10678075.6951, 5080030.0033000037], [-10677754.984200001, 5078331.3581999987], [-10679187.997099999, 5076095.9640000015], [-10678842.7983, 5073164.9302000031], [-10679735.241800001, 5070745.6897], [-10678843.2433, 5066634.3233999982], [-10681899.628900001, 5063496.7876000032], [-10678415.1086, 5059890.9783999994], [-10673931.044600001, 5059374.7233999968], [-10672407.8597, 5056961.4588999972], [-10672873.1741, 5054579.9007999972], [-10675855.316099999, 5052896.3923000023], [-10676939.396600001, 5053659.4497999996], [-10676195.839199999, 5056846.6142000034], [-10678616.2587, 5056461.6582000032], [-10678728.023, 5053927.0527999997], [-10677107.771199999, 5052608.1564000025], [-10678022.0381, 5051214.8025000021], [-10676722.3817, 5047003.8263000026], [-10678653.328500001, 5041896.7365999967], [-10677333.524700001, 5039708.8038000017], [-10671509.0703, 5040147.5323999971], [-10669103.561899999, 5038546.5495000035], [-10669634.4449, 5036946.8611999974], [-10672323.1494, 5037099.3189999983], [-10673595.5265, 5035361.3386000022], [-10671356.5606, 5025579.4897999987], [-10673573.4892, 5021109.9092999995], [-10671047.870999999, 5017608.0966000035], [-10671860.17, 5012501.7004999965], [-10667723.645400001, 5009000.483099997], [-10668831.3873, 5002431.7776999995], [-10665451.285399999, 4996613.0623999983], [-10666180.8738, 4994635.0992000028], [-10669726.622300001, 4992350.6253999993], [-10668546.746300001, 4988085.6338], [-10669454.667300001, 4984551.704400003], [-10668290.1533, 4979976.5437000021], [-10673482.982100001, 4975626.1424999982], [-10673908.2271, 4971289.5775000006], [-10670469.231899999, 4968803.3640000001], [-10669117.814200001, 4964840.4443999976], [-10662606.291300001, 4961582.8392999992], [-10660948.073899999, 4956637.6741999984], [-10658806.1807, 4954522.7655000016], [-10658871.7435, 4952979.623999998], [-10661591.2817, 4949645.9431999996], [-10660381.126800001, 4946759.0706999972], [-10660987.5942, 4944236.8913000003], [-10660272.4778, 4943023.4188999981], [-10657931.5381, 4942368.634800002], [-10655227.477399999, 4942937.3042000011], [-10654231.6153, 4942024.6381999999], [-10652773.773600001, 4943558.0007999986], [-10652623.714299999, 4947208.7283999994], [-10650905.835000001, 4948032.0546000004], [-10648360.289000001, 4945694.8659000024], [-10649009.6173, 4941403.8896000013], [-10653271.817299999, 4939641.438699998], [-10652679.821799999, 4934690.7831000015], [-10648441.2195, 4929899.4165999964], [-10648889.501700001, 4926054.6649999991], [-10644668.4922, 4915813.1369000003], [-10645221.083000001, 4914365.7215000018], [-10648124.403999999, 4912930.3448000029], [-10648525.045600001, 4911218.3894999996], [-10647189.3192, 4910464.7005999982], [-10643305.3825, 4911672.9886000007], [-10637930.655200001, 4909248.240199998], [-10636757.685699999, 4907979.5331000015], [-10636852.6373, 4904074.7670999989], [-10628639.596899999, 4901413.8677999973], [-10627640.394200001, 4899116.7309999987], [-10629043.1283, 4895145.6507999972], [-10628695.1438, 4892957.5099000037], [-10623925.6643, 4889033.9140999988], [-10622930.5767, 4885522.4728000015], [-10619909.029999999, 4884457.4299999997], [-10619138.811699999, 4883280.9927999973], [-10622254.9805, 4874773.6538000032], [-10621561.011299999, 4871806.255400002], [-10618936.2108, 4869875.0542000011], [-10614177.302100001, 4870200.5505999997], [-10610447.4299, 4867696.4148000032], [-10609670.310799999, 4865941.9917000011], [-11360348.176899999, 4866389.574500002], [-11360345.171499999, 5012689.6213999987], [-11583154.693499999, 5012549.0520000011], [-11583143.897399999, 5311966.9770999998], [-11573442.6523, 5312231.1653999984]], [[-11363864.091499999, 5302301.8341000006], [-11363864.1493, 5302298.5628999993], [-11363864.091499999, 5302299.3256999999], [-11363864.091499999, 5302301.8341000006]], [[-11445396.4604, 5227016.2400999963], [-11445400.165100001, 5227016.1649999991], [-11445397.327400001, 5227016.1649999991], [-11445396.4604, 5227016.2400999963]], [[-11358936.536599999, 5211053.3237000033], [-11358937.259099999, 5211001.7127000019], [-11358937.201300001, 5211002.5737999976], [-11358936.536599999, 5211053.3237000033]], [[-11085266.832900001, 5173934.0667999983], [-11085271.8148, 5173933.9917000011], [-11085267.751800001, 5173933.9917000011], [-11085266.832900001, 5173934.0667999983]], [[-11091645.2709, 5173933.0208000019], [-11091650.0853, 5173932.945600003], [-11091646.2477, 5173932.945600003], [-11091645.2709, 5173933.0208000019]], [[-11087331.251800001, 5173932.1191999987], [-11087330.4484, 5173932.0439999998], [-11087323.8771, 5173932.0439999998], [-11087331.251800001, 5173932.1191999987]], [[-11085880.0912, 5173931.818599999], [-11085883.5185, 5173931.7435000017], [-11085881.068, 5173931.7435000017], [-11085880.0912, 5173931.818599999]], [[-11092557.341600001, 5173925.5940999985], [-11092713.4925, 5173923.6463999972], [-11092712.689200001, 5173923.6463999972], [-11092557.341600001, 5173925.5940999985]], [[-11432766.681600001, 5172140.1002999991], [-11432766.6527, 5172139.314199999], [-11432766.739399999, 5172143.174999997], [-11432766.681600001, 5172140.1002999991]], [[-11359336.392200001, 5162297.6591000035], [-11359341.738299999, 5162297.5839999989], [-11359337.3979, 5162297.5839999989], [-11359336.392200001, 5162297.6591000035]], [[-11362118.9329, 5131542.2066000029], [-11362118.990700001, 5131538.8832999989], [-11362118.9329, 5131539.7444999963], [-11362118.9329, 5131542.2066000029]], [[-11360712.3035, 5066089.5292000026], [-11360712.4133, 5066087.3039999977], [-11360712.3035, 5066088.7893999964], [-11360712.3035, 5066089.5292000026]], [[-11360718.424000001, 5065470.9768000022], [-11360719.759099999, 5065336.3140999973], [-11360719.4297, 5065559.2993000001], [-11360718.424000001, 5065470.9768000022]], [[-11360730.7806, 5064219.2383000031], [-11360730.9482, 5064212.7884000018], [-11360730.8904, 5064213.6032999977], [-11360730.7806, 5064219.2383000031]], [[-11360745.0329, 5060818.7694000006], [-11360744.142899999, 5060773.7008000016], [-11360744.142899999, 5060774.4463], [-11360745.0329, 5060818.7694000006]], [[-11360743.1372, 5060614.7930999994], [-11360744.3336, 5060543.6010000035], [-11360744.3047, 5060544.4563999996], [-11360743.1372, 5060614.7930999994]], [[-11360749.986, 5060082.9738999978], [-11360749.0381, 5060055.5153999999], [-11360749.928200001, 5060082.1185000017], [-11360749.986, 5060082.9738999978]], [[-11422536.1404, 5045805.3229999989], [-11422536.1404, 5045804.6525000036], [-11422535.4757, 5045971.2412], [-11422536.1404, 5045805.3229999989]], [[-11360777.981899999, 5040773.1242000014], [-11360778.0339, 5040766.2061000019], [-11360777.981899999, 5040767.0556999967], [-11360777.981899999, 5040773.1242000014]], [[-11360799.9672, 5030814.9077999964], [-11360799.909399999, 5030811.2841000035], [-11360799.909399999, 5030812.0239000022], [-11360799.9672, 5030814.9077999964]], [[-11360803.8048, 5029939.8606999964], [-11360803.862600001, 5029937.4217000008], [-11360803.8048, 5029938.0922000036], [-11360803.8048, 5029939.8606999964]], [[-11360804.088, 5028289.254900001], [-11360804.030200001, 5028284.2730000019], [-11360804.030200001, 5028288.4804999977], [-11360804.088, 5028289.254900001]], [[-11360770.855799999, 5020367.3400999978], [-11360770.8847, 5020364.1325000003], [-11360770.855799999, 5020364.9821000025], [-11360770.855799999, 5020367.3400999978]], [[-11360771.861400001, 5020262.2339000031], [-11360771.9134, 5020259.8007000014], [-11360771.861400001, 5020260.4654000029], [-11360771.861400001, 5020262.2339000031]], [[-11360354.0778, 5017810.7956999987], [-11360355.522600001, 5017691.0327000022], [-11360354.0778, 5017809.9865999967], [-11360354.0778, 5017810.7956999987]], [[-11360350.292199999, 5013589.1504999995], [-11360349.737400001, 5013420.2038000003], [-11360349.737400001, 5013420.9030999988], [-11360350.292199999, 5013589.1504999995]]]
        }
    }, {
        "attributes" : {
            "OBJECTID" : 52,
            "NAME" : "Wyoming",
            "MEDNW_CY" : 77010
        },
        "geometry" : {
            "rings" : [[[-12145331.9255, 5622448.1613000035], [-12142807.977499999, 5621433.3250999972], [-11950307.5274, 5621742.9914000034], [-11827775.710000001, 5620527.8430000022], [-11791871.3934, 5620521.3931000009], [-11789775.805599999, 5621671.2040999979], [-11583649.841700001, 5621109.0307999998], [-11583154.693499999, 5012549.0520000011], [-12361664.659400001, 5012040.6225000024], [-12361374.892000001, 5349654.5046000034], [-12362608.205400001, 5621729.4557999969], [-12332530.678100001, 5621986.2280000001], [-12323654.508000001, 5620313.1398999989], [-12300888.1108, 5620308.1001999974], [-12289997.6185, 5620547.048299998], [-12285519.3456, 5621614.8422000036], [-12267352.562199999, 5620921.3874000013], [-12257400.599300001, 5622136.2699000016], [-12145331.9255, 5622448.1613000035]], [[-12307310.132100001, 5190288.1926999986], [-12307307.462000001, 5190285.0371000022], [-12307310.663800001, 5190288.8342000023], [-12307310.132100001, 5190288.1926999986]], [[-11967446.6325, 5125766.7334999964], [-11967446.7192, 5125727.1092000008], [-11966711.565099999, 5125990.8284000009], [-11967446.6325, 5125766.7334999964]]]
        }
    }]
}]'''


for jsonobject in json.loads(jsonInput):
    # Determine geometry type
    geomType = jsonobject["geometryType"]
    geomType = geomType.upper()
    
    if 'POLYGON' in geomType:
        geomType = shapefile.POLYGON
        for feature in jsonobject["features"]:
            attrib = feature["attributes"].values()
            print list(attrib)
    elif 'LINE' in geomType:
        geomType = shapefile.POLYLINE
        WritePolylines(jsonobject["features"], jsonobject["fields"])
    elif 'POINT' in geomType:
        geomType = shapefile.POINT
        WritePoints(jsonobject["features"], jsonobject["fields"])
    
    
    # Create the shapefile writer
    #w = shapefile.Writer(geomType)
    

